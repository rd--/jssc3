<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<link rel="icon" type="image/png" href="png/os.512.png" />
		<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/aaaakshat/cm-web-fonts@latest/fonts.css" />
		<link rel="stylesheet" type="text/css" media="all" href="css/sc3.css" />
		<script src="lib/commonmark.js/dist/commonmark.js"></script>
		<script src="lib/osc.js/dist/osc-browser.js"></script>
		<script type="module">
import * as sc from './dist/jssc3.js'
import * as sl from '../lib/spl/dist/sl.js'
globalThis.sc = sc;
globalThis.sl = sl;
globalThis.playUgen = (ugenGraph) => sc.scsynthEnsure(globalScsynth, () => sc.playUgen(globalScsynth, ugenGraph, 1));
globalThis.splEval = () => eval(sl.rewriteString(sc.get_selected_text_or_contents_of('programText')));
globalThis.splInsertText = function(text) {
	if(text[0] === '#') {
		var reader = new commonmark.Parser();
		var writer = new commonmark.HtmlRenderer();
		document.getElementById('documentText').innerHTML = writer.render(reader.parse(text));
	} else {
		document.getElementById('programText').textContent = text;
	}
};
globalThis.splLoad = () => sc.read_text_file_from_file_input_and_then('programInputFile', 0, splInsertText);
globalThis.splHelp = function() {
	const name = sc.get_selected_text();
	if(name.length > 0) {
		const helpPrefix = 'https://rohandrape.net/sw/stsc3/help/sc2/help/unit-generators';
		const docPrefix = 'https://rohandrape.net/sw/spl/doc';
		const url = `${name.includes(' ') ? docPrefix : helpPrefix}/${name}.help.sl`;
		sc.load_utf8_and_then(url, splInsertText);
	}
};
globalThis.splKey = function(event) {
	// console.log('splKey', event.ctrlKey, event.shiftKey, event.key);
	if(event.ctrlKey&& event.key === 'Enter') {
		event.shiftKey ? playUgen(splEval()) : splEval();
	} else if(event.ctrlKey&& event.key === '.') {
		sc.resetScsynth(globalScsynth);
		_clear(_system.get('clock'));
	} else if(event.ctrlKey&& event.shiftKey && event.key === 'L') {
		document.getElementById('programInputFileSelect').click();
	} else if(event.ctrlKey&& event.shiftKey && event.key === 'H') {
		splHelp();
	}
};
sl.addLoadUrlMethods();
window.onload = function () {
	sc.sc3_wasm_init(sc.setStatusDisplay);
	sc.sc3_mouse_init(globalScsynth);
	sc.connect_button_to_input('programInputFileSelect', 'programInputFile');
	sl.assignGlobals();
	sl.loadUrlArrayInSequence('lib/spl/sl', ['prelude.sl', 'sc.sl']);
	document.getElementById('documentContainer').addEventListener("keydown", splKey);
	document.getElementById('plaintextContainer').addEventListener("keydown", splKey);
};
		</script>
	</head>
	<body>
		<h1>Simple Programming Language</h1>
		<div id="menuContainer">
			<button title="Boot" accesskey="b" onclick="globalScsynth.boot()">Begin</button>
			<span id="statusText">â€¦</span>
			<input type="file" id="programInputFile" accept=".stc, .sl, .sld, .md" onchange="splLoad()" style="display:none">
			<button id="programInputFileSelect" title="Load (l)" accesskey="l">Load</button>
			<button title="Evaluate (/)" accesskey="/" onclick="splEval()">Eval</button>
			<button title="Play (,)" accesskey="," onclick="playUgen(splEval())">Play</button>
			<button title="Reset (.)" accesskey="." onclick="sc.resetScsynth(globalScsynth)">Reset</button>
			<button title="Clear Schedule(\)" accesskey="\" onclick="_clear(_system.get('clock'))">Clear</button>
			<button title="Print" onclick="sc.prettyPrintSyndefOf(splEval())">Text</button>
		</div>
		<div id="documentContainer">
			<div id="documentText" contenteditable="true" spellcheck="false"></div>
		</div>
		<div id="plaintextContainer">
			<pre><code id="programText" contenteditable="true" spellcheck="false"></code></pre>
		</div>
		<script async src="lib/scsynth-wasm-builds/ext/scsynth.js"></script>
	</body>
</html>
